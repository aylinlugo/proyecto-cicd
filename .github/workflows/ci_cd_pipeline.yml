name: CI/CD Pipeline (Windows)

permissions:
  contents: write      # ‚úÖ Permiso para hacer push y crear tags
  actions: read
  checks: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Generar entorno
        run: .\scripts\generar_entorno.ps1
        shell: pwsh

      - name: Ejecutar pruebas
        run: .\scripts\pruebas_entorno.ps1
        shell: pwsh

      - name: Generar despliegue
        run: .\scripts\generar_despliegue.ps1
        shell: pwsh

      # üîπ Nueva etapa: calcular autom√°ticamente la pr√≥xima versi√≥n
      - name: Calcular siguiente versi√≥n
        id: version
        shell: pwsh
        run: |
          Write-Host "==> Calculando siguiente versi√≥n..."
          $tag = git tag --sort=-v:refname | Select-Object -First 1
          if (-not $tag) { $tag = "v1.0.0" }
          else {
            $version = $tag.TrimStart("v") -split '\.'
            $major = [int]$version[0]
            $minor = [int]$version[1]
            $patch = [int]$version[2] + 1
            $tag = "v$major.$minor.$patch"
          }
          echo "next_tag=$tag" >> $env:GITHUB_OUTPUT
          Write-Host "Versi√≥n siguiente: $tag"

      - name: Liberar versi√≥n autom√°ticamente
        if: github.ref == 'refs/heads/main'
        run: .\scripts\liberar_version.ps1 -Version ${{ steps.version.outputs.next_tag }}
        shell: pwsh
