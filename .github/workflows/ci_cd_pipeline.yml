name: CI/CD Pipeline (Windows)

permissions:
  contents: write
  actions: read
  checks: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: windows-latest

    steps:
      # 1. Checkout
      - name: Checkout del repositorio
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      # 2. Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # 3. Generar entorno
      - name: Generar entorno
        run: .\scripts\generar_entorno.ps1
        shell: pwsh

      # 4. Ejecutar pruebas
      - name: Ejecutar pruebas
        run: .\scripts\pruebas_entorno.ps1
        shell: pwsh

      # 5. Generar despliegue (versionamiento)
      - name: Generar despliegue
        run: .\scripts\generar_despliegue.ps1
        shell: pwsh

      # 6. Calcular siguiente versión automáticamente
      - name: Calcular siguiente versión
        id: version
        shell: pwsh
        run: |
          Write-Host "==> Calculando siguiente versión..."
          $tag = git tag --sort=-v:refname | Select-Object -First 1
          if (-not $tag) { $tag = "v1.0.0" }
          else {
            $version = $tag.TrimStart("v") -split '\.'
            $major = [int]$version[0]
            $minor = [int]$version[1]
            $patch = [int]$version[2] + 1
            $tag = "v$major.$minor.$patch"
          }
          echo "next_tag=$tag" >> $env:GITHUB_OUTPUT
          Write-Host "Versión siguiente: $tag"

      # 7. Liberar versión automáticamente
      - name: Liberar versión automáticamente
        if: github.ref == 'refs/heads/main'
        run: .\scripts\liberar_version.ps1 -Version ${{ steps.version.outputs.next_tag }}
        shell: pwsh

      # 8. Login a Docker Hub
      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # 9. Build y push de Docker
      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USER }}/proyecto-cicd:latest .
          docker push ${{ secrets.DOCKER_USER }}/proyecto-cicd:latest
        shell: pwsh

      # 10. Deploy a Railway
      - name: Deploy to Railway
        run: |
          echo "Deploy usando Railway: imagen ya subida a Docker Hub"
        shell: pwsh
